---

- name: Gracefully Stop fluentd
  block:  
    - name: Get fluentd proc number
      shell: "ps -ef | grep -v grep | grep -w fluentd | awk '{print $2}'"
      register: fluentd.proc_number
      delegate_to: "{{host_to_redeploy.hostname}}.{{cluster_vars.dns_zone_external}}"

    - name: Stop fluentd
      become: yes
      service:
        name: fluentd
        state: stopped
      delegate_to: "{{host_to_redeploy.hostname}}.{{cluster_vars.dns_zone_external}}"

    - name: Wait until the process is finished and pid was destroyed
      wait_for:
        path: "{{ fluentd.pid_dir }}/{{ fluentd.proc_number.stdout }}/status"
        state: absent
      delegate_to: "{{host_to_redeploy.hostname}}.{{cluster_vars.dns_zone_external}}"
  when: "'fluentd' in host_to_redeploy.hostname"